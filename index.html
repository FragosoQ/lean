<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NutriCore - Suporte MetabÃ³lico</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800;900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            -webkit-tap-highlight-color: transparent;
            line-height: 1.5;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.7);
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        input {
            font-size: 16px !important; /* Essencial para evitar zoom no iOS */
        }

        .transition-all {
            transition: all 0.2s ease-in-out;
        }

        .active-tab-glow {
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
        }

        /* Ajuste de toque para botÃµes */
        button, .clickable {
            min-height: 44px;
        }
    </style>
</head>
<body class="selection:bg-emerald-100 selection:text-emerald-900 pb-32 min-h-screen">
    <!-- Fundo -->
    <div class="fixed top-[-10%] left-[-10%] w-[70%] h-[40%] bg-emerald-100/40 blur-[100px] rounded-full pointer-events-none -z-10"></div>
    <div class="fixed bottom-[-10%] right-[-10%] w-[70%] h-[40%] bg-blue-100/40 blur-[100px] rounded-full pointer-events-none -z-10"></div>

    <!-- CabeÃ§alho -->
    <header class="sticky top-0 z-50 bg-white/90 backdrop-blur-md border-b border-slate-200 px-4 py-4">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="p-2.5 bg-emerald-500 rounded-2xl shadow-lg shadow-emerald-200/50">
                    <i data-lucide="zap" class="w-5 h-5 text-white fill-white"></i>
                </div>
                <div>
                    <h1 class="text-xl font-black tracking-tight text-slate-900 uppercase italic leading-none">
                        Nutri<span class="text-emerald-600">Core</span>
                    </h1>
                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mt-1">Metabolismo 2.0</p>
                </div>
            </div>
            <div class="text-right">
                <div class="flex flex-col items-end gap-1">
                    <div class="flex items-center gap-2">
                        <div class="flex items-center gap-1 text-[11px] font-black text-orange-600 bg-orange-50 px-2.5 py-1 rounded-lg border border-orange-100 shadow-sm">
                            <i data-lucide="flame" class="w-3 h-3"></i> <span id="header-net-cals">0</span>
                        </div>
                        <div class="flex items-center gap-1 text-[11px] font-black text-blue-600 bg-blue-50 px-2.5 py-1 rounded-lg border border-blue-100 shadow-sm">
                            <i data-lucide="dna" class="w-3 h-3"></i> <span id="header-protein">0</span>g
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto p-4 sm:p-6 relative z-10">
        <!-- Dashboard -->
        <section id="dashboard" class="grid grid-cols-2 gap-4 mb-8">
            <div class="glass-card rounded-3xl p-5 shadow-sm border border-white flex flex-col justify-between min-h-[110px]">
                <div class="flex items-center justify-between mb-2">
                    <h2 class="text-xs font-black text-slate-400 uppercase tracking-widest flex items-center gap-1.5">
                        <i data-lucide="activity" class="w-4 h-4 text-emerald-500"></i> Sucesso
                    </h2>
                    <span id="weekly-progress-text" class="text-emerald-600 font-black text-base">0%</span>
                </div>
                <div class="w-full bg-slate-100 rounded-full h-2 overflow-hidden mb-2">
                    <div id="weekly-progress-bar" class="bg-emerald-500 h-full rounded-full transition-all duration-700" style="width: 0%"></div>
                </div>
                <button onclick="archiveWeek()" id="btn-archive" class="w-full py-2 bg-slate-900 text-white rounded-xl text-[10px] font-black uppercase tracking-widest hidden transition-all active:scale-95 shadow-lg">
                    Finalizar Semana
                </button>
            </div>

            <div class="glass-card rounded-3xl p-5 shadow-sm border border-white min-h-[110px]">
                <div class="flex items-center justify-between mb-2">
                    <h2 class="text-xs font-black text-slate-400 uppercase tracking-widest flex items-center gap-1.5"><i data-lucide="plus" class="w-4 h-4 text-orange-500"></i> Dieta</h2>
                    <span id="consumed-cals-text" class="text-orange-600 font-mono font-bold text-xs">0 kcal</span>
                </div>
                <div class="w-full bg-slate-100 rounded-full h-2 mb-2">
                    <div id="consumed-cals-bar" class="bg-orange-500 h-full rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
                <p class="text-[10px] text-slate-400 font-semibold uppercase">Calorias Ingeridas</p>
            </div>

            <div class="glass-card rounded-3xl p-5 shadow-sm border border-white min-h-[110px]">
                <div class="flex items-center justify-between mb-2">
                    <h2 class="text-xs font-black text-slate-400 uppercase tracking-widest flex items-center gap-1.5"><i data-lucide="minus" class="w-4 h-4 text-blue-500"></i> Queima</h2>
                    <span id="burned-cals-text" class="text-blue-600 font-mono font-bold text-xs">0 kcal</span>
                </div>
                <div class="w-full bg-slate-100 rounded-full h-2 mb-2">
                    <div id="burned-cals-bar" class="bg-blue-500 h-full rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
                <p class="text-[10px] text-slate-400 font-semibold uppercase">Gasto Ativo</p>
            </div>

            <div class="glass-card rounded-3xl p-5 shadow-sm border border-white min-h-[110px]">
                <div class="flex items-center justify-between mb-2">
                    <h2 class="text-xs font-black text-slate-400 uppercase tracking-widest flex items-center gap-1.5"><i data-lucide="dna" class="w-4 h-4 text-emerald-500"></i> Macros</h2>
                    <span id="protein-text" class="text-emerald-600 font-mono font-bold text-xs">0g</span>
                </div>
                <div class="w-full bg-slate-100 rounded-full h-2 mb-2">
                    <div id="protein-bar" class="bg-emerald-500 h-full rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
                <p class="text-[10px] text-slate-400 font-semibold uppercase">ProteÃ­na Consumida</p>
            </div>
        </section>

        <!-- NavegaÃ§Ã£o de Abas -->
        <nav class="flex bg-slate-200/50 backdrop-blur-md rounded-2xl p-1.5 mb-8 border border-white shadow-sm sticky top-24 z-40">
            <button onclick="switchTab('meals')" id="tab-meals" class="tab-btn flex-1 flex items-center justify-center gap-2 py-3 rounded-xl font-bold text-xs uppercase tracking-widest transition-all bg-white text-emerald-600 shadow-sm active-tab-glow">
                <i data-lucide="utensils" class="w-4 h-4"></i> Plano
            </button>
            <button onclick="switchTab('shopping')" id="tab-shopping" class="tab-btn flex-1 flex items-center justify-center gap-2 py-3 rounded-xl font-bold text-xs uppercase tracking-widest transition-all text-slate-500">
                <i data-lucide="shopping-cart" class="w-4 h-4"></i> Compras
            </button>
            <button onclick="switchTab('history')" id="tab-history" class="tab-btn flex-1 flex items-center justify-center gap-2 py-3 rounded-xl font-bold text-xs uppercase tracking-widest transition-all text-slate-500">
                <i data-lucide="history" class="w-4 h-4"></i> Registo
            </button>
        </nav>

        <!-- ConteÃºdo -->
        <div id="view-meals" class="tab-view space-y-6">
            <div id="day-selector" class="flex gap-2 overflow-x-auto pb-4 no-scrollbar">
                <!-- Injetado via JS -->
            </div>
            
            <div id="exercise-card">
                <!-- Injetado via JS -->
            </div>

            <div id="meal-cards-container" class="space-y-4">
                <!-- Injetado via JS -->
            </div>
        </div>

        <div id="view-shopping" class="tab-view hidden space-y-6">
            <div class="bg-emerald-600 rounded-3xl p-6 text-white shadow-xl relative overflow-hidden">
                <h3 class="font-black text-xl flex items-center gap-3"><i data-lucide="shopping-cart" class="w-6 h-6"></i> Lista de Compras</h3>
                <p id="shopping-summary" class="text-emerald-100 text-xs font-bold uppercase tracking-wider mt-2 italic">A carregar...</p>
            </div>
            <div id="shopping-container" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Injetado via JS -->
            </div>
        </div>

        <div id="view-history" class="tab-view hidden space-y-6">
            <h2 class="text-lg font-black text-slate-800 flex items-center gap-2 px-1 uppercase tracking-tight">
                <i data-lucide="history" class="w-5 h-5 text-emerald-600"></i> Registo de Semanas
            </h2>
            <div id="history-container" class="space-y-4">
                <!-- Injetado via JS -->
            </div>
        </div>
    </main>

    <!-- Barra Inferior Mobile -->
    <div class="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-xl border-t border-slate-200 px-6 pt-3 pb-8 md:hidden z-50">
        <div class="flex justify-around items-center max-w-lg mx-auto">
            <button onclick="switchTab('meals')" class="mobile-tab-btn flex flex-col items-center gap-1.5 group" data-tab="meals">
                <div class="p-3 rounded-2xl transition-all bg-emerald-500 text-white shadow-lg active-tab-glow"><i data-lucide="calendar" class="w-6 h-6"></i></div>
                <span class="text-[10px] font-black uppercase tracking-widest text-emerald-600">Plano</span>
            </button>
            <button onclick="switchTab('shopping')" class="mobile-tab-btn flex flex-col items-center gap-1.5 group" data-tab="shopping">
                <div class="p-3 rounded-2xl transition-all relative text-slate-400">
                    <i data-lucide="shopping-cart" class="w-6 h-6"></i>
                    <span id="shopping-badge" class="absolute top-1 right-1 bg-red-500 text-white text-[9px] w-4 h-4 rounded-full flex items-center justify-center font-black border-2 border-white hidden">0</span>
                </div>
                <span class="text-[10px] font-black uppercase tracking-widest text-slate-400">Compras</span>
            </button>
            <button onclick="switchTab('history')" class="mobile-tab-btn flex flex-col items-center gap-1.5 group" data-tab="history">
                <div class="p-3 rounded-2xl transition-all text-slate-400"><i data-lucide="history" class="w-6 h-6"></i></div>
                <span class="text-[10px] font-black uppercase tracking-widest text-slate-400">Registo</span>
            </button>
        </div>
    </div>

    <script>
        // --- ESTADO ---
        let activeTab = 'meals';
        let selectedDay = '2Âª';
        let completedMeals = {};
        let checkedItems = {};
        let dailyExercise = { '2Âª': { name: '', cals: 0 }, '3Âª': { name: '', cals: 0 }, '4Âª': { name: '', cals: 0 }, '5Âª': { name: '', cals: 0 }, '6Âª': { name: '', cals: 0 } };
        let history = [
            { id: 1, date: "03 Fev - 09 Fev", completion: 85, avgCals: 1240, avgProtein: 98, totalBurned: 1200, exercises: ["Corrida 5km", "Treino de Pernas"] }
        ];
        let expandedHistoryId = null;

        const daysList = ['2Âª', '3Âª', '4Âª', '5Âª', '6Âª'];
        
        const mealData = {
            '2Âª': [
                { id: 'pq', title: "Pequeno-AlmoÃ§o", content: "2 ovos + 1 banana", cals: 245, protein: 14, icon: 'clock' },
                { id: 'al', title: "AlmoÃ§o", content: "Frango 150g + arroz 75g (cru)", subtitle: "Legumes: BrÃ³colos", cals: 465, protein: 42, icon: 'activity' },
                { id: 'la', title: "Lanche", content: "Skyr (170g)", cals: 110, protein: 18, icon: 'zap' },
                { id: 'ja', title: "Jantar", content: "Sopa + iogurte natural + 1 scoop whey", subtitle: "Dose: 350 ml", cals: 320, protein: 28, icon: 'chef-hat' }
            ],
            '3Âª': [
                { id: 'pq', title: "Pequeno-AlmoÃ§o", content: "2 ovos + 1 banana", cals: 245, protein: 14, icon: 'clock' },
                { id: 'al', title: "AlmoÃ§o", content: "Frango 150g + grÃ£o 100g", subtitle: "Legumes: Cenoura baby", cals: 365, protein: 40, icon: 'activity' },
                { id: 'la', title: "Lanche", content: "Atum (1 lata)", cals: 85, protein: 22, icon: 'zap' },
                { id: 'ja', title: "Jantar", content: "Sopa + omelete (2 ovos + 1 clara)", subtitle: "Dose: 350 ml", cals: 315, protein: 18, icon: 'chef-hat' }
            ],
            '4Âª': [
                { id: 'pq', title: "Pequeno-AlmoÃ§o", content: "2 ovos + 1 banana", cals: 245, protein: 14, icon: 'clock' },
                { id: 'al', title: "AlmoÃ§o", content: "SalmÃ£o 150g + arroz 60g (cru)", subtitle: "Legumes: Espinafres", cals: 535, protein: 35, icon: 'activity' },
                { id: 'la', title: "Lanche", content: "Iogurte proteico", cals: 95, protein: 20, icon: 'zap' },
                { id: 'ja', title: "Jantar", content: "Sopa + skyr", subtitle: "Dose: 350 ml", cals: 260, protein: 20, icon: 'chef-hat' }
            ],
            '5Âª': [
                { id: 'pq', title: "Pequeno-AlmoÃ§o", content: "2 ovos + 1 banana", cals: 245, protein: 14, icon: 'clock' },
                { id: 'al', title: "AlmoÃ§o", content: "Frango 150g + batata 250g", subtitle: "Legumes: Mistura Vegetais", cals: 410, protein: 38, icon: 'activity' },
                { id: 'la', title: "Lanche", content: "Skyr (170g)", cals: 110, protein: 18, icon: 'zap' },
                { id: 'ja', title: "Jantar", content: "Sopa + iogurte natural + 1 scoop whey", subtitle: "Dose: 350 ml", cals: 320, protein: 28, icon: 'chef-hat' }
            ],
            '6Âª': [
                { id: 'pq', title: "Pequeno-AlmoÃ§o", content: "2 ovos + 1 banana", cals: 245, protein: 14, icon: 'clock' },
                { id: 'al', title: "AlmoÃ§o", content: "SalmÃ£o 150g + grÃ£o 100g", subtitle: "Legumes: Couve Bruxelas", cals: 495, protein: 36, icon: 'activity' },
                { id: 'la', title: "Lanche", content: "Iogurte + Atum", cals: 105, protein: 15, icon: 'zap' },
                { id: 'ja', title: "Jantar", content: "Sopa + atum ou skyr", subtitle: "Dose: 350 ml", cals: 255, protein: 25, icon: 'chef-hat' }
            ]
        };

        const shoppingList = [
            { id: 1, cat: 'ProteÃ­na', prod: 'Ovos (12 un)', qty: '12 un', price: 3.09, status: 'Comprar', day: '2Âª' },
            { id: 2, cat: 'ProteÃ­na', prod: 'Peru (bifes/perna)', qty: '300 g', price: 2.10, status: 'Comprar', day: '2Âª' },
            { id: 3, cat: 'ProteÃ­na', prod: 'Frango (peito)', qty: '600 g', price: 1.98, status: 'Comprar', day: '2Âª' },
            { id: 4, cat: 'ProteÃ­na', prod: 'SalmÃ£o (lombos/postas)', qty: '400 g', price: 4.00, status: 'Comprar', day: '2Âª' },
            { id: 5, cat: 'ProteÃ­na', prod: 'Atum ao natural', qty: '3 latas', price: 2.67, status: 'Comprar', day: '2Âª' },
            { id: 6, cat: 'ProteÃ­na', prod: 'Skyr natural (150 g)', qty: '3 un', price: 1.95, status: 'Comprar', day: '2Âª' },
            { id: 7, cat: 'ProteÃ­na', prod: 'Iogurte proteico', qty: '1 un', price: 0.85, status: 'Comprar', day: '2Âª' },
            { id: 8, cat: 'ProteÃ­na', prod: 'Iogurte natural', qty: '2 un', price: 0.35, status: 'Comprar', day: '2Âª' },
            { id: 9, cat: 'ProteÃ­na', prod: 'Whey', qty: '90 g', price: 3.20, status: 'Stock', day: 'â€”' },
            { id: 10, cat: 'Hidratos', prod: 'Arroz', qty: '500 g', price: 0.58, status: 'Comprar', day: '2Âª' },
            { id: 11, cat: 'Hidratos', prod: 'Batata', qty: '1 kg', price: 2.99, status: 'Comprar', day: '2Âª' },
            { id: 12, cat: 'Hidratos', prod: 'Banana', qty: '5 un', price: 1.30, status: 'Comprar', day: '2Âª' },
            { id: 13, cat: 'Hidratos', prod: 'GrÃ£o', qty: '400 g', price: 0.90, status: 'Comprar', day: '2Âª' },
            { id: 14, cat: 'Legumes', prod: 'BrÃ³colos', qty: '400 g', price: 2.34, status: 'Comprar', day: '2Âª' },
            { id: 15, cat: 'Legumes', prod: 'Cenoura baby', qty: '750gr', price: 1.39, status: 'Comprar', day: '2Âª' },
            { id: 17, cat: 'Legumes', prod: 'Espinafres em folha', qty: '750 g', price: 1.29, status: 'Comprar', day: '4Âª' },
            { id: 18, cat: 'Legumes', prod: 'Mistura Vegetais', qty: '1Kg', price: 1.89, status: 'Comprar', day: '2Âª' },
            { id: 24, cat: 'Legumes', prod: 'Couve Bruxelas', qty: '750gr', price: 1.29, status: 'Comprar', day: '2Âª' },
            { id: 20, cat: 'Legumes', prod: 'Cebola', qty: '~300 g', price: 0.56, status: 'Comprar', day: '2Âª' },
            { id: 21, cat: 'Sopa', prod: 'AgriÃ£o (800gr)', qty: '1 un', price: 2.49, status: 'Comprar', day: '2Âª' },
            { id: 22, cat: 'Sopa', prod: 'Creme Legumes', qty: '1 un', price: 2.49, status: 'Comprar', day: '4Âª' },
            { id: 23, cat: 'Sopa', prod: 'Creme Cenoura', qty: '1 un', price: 2.49, status: 'Comprar', day: '5Âª' },
        ];

        // --- LÃ“GICA ---

        function switchTab(tabId) {
            activeTab = tabId;
            document.querySelectorAll('.tab-view').forEach(view => view.classList.add('hidden'));
            document.getElementById(`view-${tabId}`).classList.remove('hidden');
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('bg-white', 'text-emerald-600', 'shadow-sm', 'active-tab-glow');
                btn.classList.add('text-slate-500');
            });
            const activeBtn = document.getElementById(`tab-${tabId}`);
            activeBtn.classList.add('bg-white', 'text-emerald-600', 'shadow-sm', 'active-tab-glow');
            activeBtn.classList.remove('text-slate-500');

            document.querySelectorAll('.mobile-tab-btn').forEach(btn => {
                btn.classList.remove('text-emerald-600', 'scale-110');
                btn.classList.add('text-slate-400');
                const inner = btn.querySelector('div');
                inner.classList.remove('bg-emerald-500', 'text-white', 'shadow-lg', 'active-tab-glow');
                const label = btn.querySelector('span');
                label.classList.remove('text-emerald-600');
                label.classList.add('text-slate-400');
            });
            const activeMobile = document.querySelector(`.mobile-tab-btn[data-tab="${tabId}"]`);
            activeMobile.classList.add('text-emerald-600', 'scale-110');
            activeMobile.querySelector('div').classList.add('bg-emerald-500', 'text-white', 'shadow-lg', 'active-tab-glow');
            const activeLabel = activeMobile.querySelector('span');
            activeLabel.classList.add('text-emerald-600');
            activeLabel.classList.remove('text-slate-400');

            render();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function updateSelectedDay(day) { selectedDay = day; render(); }
        function toggleMeal(mealId) { const k = `${selectedDay}-${mealId}`; completedMeals[k] = !completedMeals[k]; render(); }
        function toggleShopping(id) { checkedItems[id] = !checkedItems[id]; render(); }
        function handleExerciseInput(field, val) { dailyExercise[selectedDay][field] = field === 'cals' ? (parseInt(val) || 0) : val; updateDashboard(); }
        
        function calculateProgressValue() {
            const total = daysList.length * 4;
            const completed = Object.values(completedMeals).filter(Boolean).length;
            return Math.round((completed / total) * 100);
        }

        function archiveWeek() {
            let cals = 0; let prot = 0; let exLog = []; let burned = 0;
            daysList.forEach(d => {
                mealData[d].forEach(i => { if (completedMeals[`${d}-${i.id}`]) { cals += i.cals; prot += i.protein; } });
                if (dailyExercise[d].cals > 0) {
                    burned += dailyExercise[d].cals;
                    exLog.push(`${d}: ${dailyExercise[d].name || 'Atividade'} (${dailyExercise[d].cals} kcal)`);
                }
            });
            history.unshift({
                id: Date.now(),
                date: `Semana de ${new Date().toLocaleDateString('pt-PT')}`,
                completion: calculateProgressValue(),
                avgCals: Math.round(cals / 5),
                avgProtein: Math.round(prot / 5),
                totalBurned: burned,
                exercises: exLog
            });
            completedMeals = {}; checkedItems = {}; dailyExercise = { '2Âª': { name: '', cals: 0 }, '3Âª': { name: '', cals: 0 }, '4Âª': { name: '', cals: 0 }, '5Âª': { name: '', cals: 0 }, '6Âª': { name: '', cals: 0 } };
            switchTab('history');
        }

        function deleteHistory(id) { history = history.filter(h => h.id !== id); render(); }
        function toggleHistoryDetails(id) { expandedHistoryId = expandedHistoryId === id ? null : id; render(); }

        // --- RENDER ---

        function updateDashboard() {
            const prog = calculateProgressValue();
            document.getElementById('weekly-progress-text').innerText = `${prog}%`;
            document.getElementById('weekly-progress-bar').style.width = `${prog}%`;
            document.getElementById('btn-archive').classList.toggle('hidden', prog === 0);

            const meals = mealData[selectedDay];
            const targetC = meals.reduce((acc, curr) => acc + curr.cals, 0);
            const targetP = meals.reduce((acc, curr) => acc + curr.protein, 0);
            const burned = dailyExercise[selectedDay].cals;
            const consumed = meals.reduce((acc, curr) => completedMeals[`${selectedDay}-${curr.id}`] ? acc + curr.cals : acc, 0);
            const consumedP = meals.reduce((acc, curr) => completedMeals[`${selectedDay}-${curr.id}`] ? acc + curr.protein : acc, 0);

            document.getElementById('header-net-cals').innerText = targetC - burned;
            document.getElementById('header-protein').innerText = targetP;
            document.getElementById('consumed-cals-text').innerText = `${consumed} kcal`;
            document.getElementById('consumed-cals-bar').style.width = `${Math.min((consumed/targetC)*100, 100)}%`;
            document.getElementById('burned-cals-text').innerText = `${burned} kcal`;
            document.getElementById('burned-cals-bar').style.width = `${Math.min((burned/1000)*100, 100)}%`;
            document.getElementById('protein-text').innerText = `${consumedP}g / ${targetP}g`;
            document.getElementById('protein-bar').style.width = `${Math.min((consumedP/targetP)*100, 100)}%`;
        }

        function renderDaySelector() {
            const container = document.getElementById('day-selector');
            container.innerHTML = daysList.map(day => `
                <button onclick="updateSelectedDay('${day}')" class="px-8 py-3 rounded-2xl font-black text-sm whitespace-nowrap transition-all border ${selectedDay === day ? 'bg-emerald-600 text-white border-emerald-600 shadow-lg scale-110 mx-2' : 'bg-white text-slate-400 border-slate-200'}">
                    ${day}
                </button>
            `).join('');
        }

        function renderExerciseCard() {
            const container = document.getElementById('exercise-card');
            container.innerHTML = `
                <div class="bg-gradient-to-br from-blue-600 to-blue-800 rounded-3xl p-6 shadow-xl text-white relative overflow-hidden group mb-6">
                    <div class="absolute top-0 right-0 p-6 opacity-10"><i data-lucide="dumbbell" class="w-20 h-20"></i></div>
                    <div class="flex flex-col gap-4 relative z-10">
                        <div>
                            <h4 class="text-[10px] font-black uppercase tracking-widest text-blue-100 mb-2 italic">Atividade FÃ­sica</h4>
                            <input type="text" placeholder="Ex: Caminhada, MusculaÃ§Ã£o..." class="bg-white/10 border border-white/20 rounded-2xl px-5 py-3.5 w-full text-white placeholder:text-blue-200 font-bold focus:outline-none focus:bg-white/20" value="${dailyExercise[selectedDay].name}" oninput="handleExerciseInput('name', this.value)">
                        </div>
                        <div>
                            <h4 class="text-[10px] font-black uppercase tracking-widest text-blue-100 mb-2 italic">Gasto Estimado (kcal)</h4>
                            <input type="number" placeholder="0" class="bg-white/10 border border-white/20 rounded-2xl px-5 py-3.5 w-full text-white placeholder:text-blue-200 font-bold focus:outline-none focus:bg-white/20 text-center" value="${dailyExercise[selectedDay].cals || ''}" oninput="handleExerciseInput('cals', this.value)">
                        </div>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        function renderMeals() {
            const container = document.getElementById('meal-cards-container');
            container.innerHTML = mealData[selectedDay].map(meal => {
                const isC = completedMeals[`${selectedDay}-${meal.id}`];
                return `
                    <div onclick="toggleMeal('${meal.id}')" class="glass-card rounded-[2rem] p-6 border transition-all cursor-pointer shadow-sm active:scale-[0.97] ${isC ? 'opacity-50 grayscale border-transparent bg-slate-100' : 'border-white'}">
                        <div class="flex items-center gap-5">
                            <div class="p-4 rounded-2xl transition-all ${isC ? 'bg-emerald-100 text-emerald-600' : 'bg-slate-50 text-slate-400 shadow-inner'}">
                                <i data-lucide="${isC ? 'check-circle-2' : meal.icon}" class="w-7 h-7"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex justify-between items-start mb-1">
                                    <h4 class="text-[10px] font-black uppercase tracking-widest ${isC ? 'text-emerald-600/50' : 'text-slate-400'}">${meal.title}</h4>
                                    <div class="flex items-center gap-2">
                                        <span class="flex items-center gap-1 bg-orange-50 px-2 py-1 rounded-lg text-[10px] font-black text-orange-600"><i data-lucide="flame" class="w-3 h-3"></i> ${meal.cals}</span>
                                        <span class="flex items-center gap-1 bg-blue-50 px-2 py-1 rounded-lg text-[10px] font-black text-blue-600"><i data-lucide="dna" class="w-3 h-3"></i> ${meal.protein}g</span>
                                    </div>
                                </div>
                                <p class="text-base font-black text-slate-900 leading-tight ${isC ? 'line-through italic text-slate-400' : ''}">${meal.content}</p>
                                ${meal.subtitle ? `<p class="text-xs mt-2 text-emerald-600/70 font-bold flex items-center gap-1"><i data-lucide="info" class="w-3 h-3"></i> ${meal.subtitle}</p>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            lucide.createIcons();
        }

        function renderShopping() {
            const container = document.getElementById('shopping-container');
            const total = shoppingList.length;
            const bought = shoppingList.filter(i => checkedItems[i.id]).length;
            document.getElementById('shopping-summary').innerText = `${bought} de ${total} produtos no carrinho`;
            
            const badge = document.getElementById('shopping-badge');
            badge.innerText = total - bought;
            badge.classList.toggle('hidden', total - bought === 0);

            container.innerHTML = ['ProteÃ­na', 'Hidratos', 'Legumes', 'Sopa'].map(cat => {
                const items = shoppingList.filter(i => i.cat === cat);
                return `
                    <div class="bg-white rounded-[2rem] p-6 shadow-sm border border-slate-100">
                        <h3 class="font-black text-slate-800 mb-5 text-xs uppercase tracking-widest border-l-4 border-emerald-500 pl-3 flex justify-between">
                            ${cat} <span class="text-slate-300 font-normal">${items.filter(i => checkedItems[i.id]).length}/${items.length}</span>
                        </h3>
                        <ul class="space-y-3">
                            ${items.map(item => {
                                const isEx = item.status !== 'Comprar' || item.day !== '2Âª';
                                const check = checkedItems[item.id];
                                return `
                                    <li onclick="toggleShopping(${item.id})" class="flex justify-between items-center p-3.5 rounded-2xl border transition-all ${check ? 'bg-slate-50 opacity-40 grayscale border-transparent' : isEx ? 'bg-amber-50/50 border-amber-100' : 'bg-white border-slate-100'}">
                                        <div class="flex items-center gap-4">
                                            <i data-lucide="${check ? 'check-square' : 'square'}" class="w-6 h-6 ${check ? 'text-emerald-500' : 'text-slate-300'}"></i>
                                            <div class="flex flex-col">
                                                <span class="text-sm font-bold leading-none mb-1">${item.prod}</span>
                                                <span class="text-[10px] text-slate-400 font-semibold">${item.qty} â€¢ ${item.day}</span>
                                            </div>
                                        </div>
                                        <span class="text-xs font-black ml-2">${item.price.toFixed(2)}â‚¬</span>
                                    </li>
                                `;
                            }).join('')}
                        </ul>
                    </div>
                `;
            }).join('');
            lucide.createIcons();
        }

        function renderHistory() {
            const container = document.getElementById('history-container');
            if (history.length === 0) {
                container.innerHTML = `<div class="p-16 text-center opacity-40 font-black uppercase text-xs tracking-widest italic">Sem registos arquivados</div>`;
            } else {
                container.innerHTML = history.map(entry => `
                    <div class="bg-white rounded-[2rem] p-6 shadow-sm border border-slate-100 overflow-hidden">
                        <div class="flex justify-between items-center">
                            <div class="min-w-0 flex-1">
                                <h3 class="text-sm font-black text-slate-800 truncate mb-3">${entry.date}</h3>
                                <div class="flex flex-wrap gap-2">
                                    <span class="bg-orange-50 text-orange-600 px-2 py-1 rounded-lg text-[9px] font-black uppercase tracking-tighter">~${entry.avgCals} kcal</span>
                                    <span class="bg-blue-50 text-blue-600 px-2 py-1 rounded-lg text-[9px] font-black uppercase tracking-tighter">~${entry.avgProtein}g P</span>
                                    <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-lg text-[9px] font-black uppercase tracking-tighter">${entry.totalBurned} kcalðŸ”¥</span>
                                </div>
                            </div>
                            <div class="flex items-center gap-4 ml-4">
                                <div class="text-right">
                                    <div class="text-[9px] text-slate-400 font-black uppercase">ConsistÃªncia</div>
                                    <div class="text-xl font-black ${entry.completion > 80 ? 'text-emerald-600' : 'text-amber-500'}">${entry.completion}%</div>
                                </div>
                                <button onclick="toggleHistoryDetails(${entry.id})" class="p-3 bg-slate-50 rounded-xl text-slate-400"><i data-lucide="${expandedHistoryId === entry.id ? 'chevron-up' : 'chevron-down'}" class="w-5 h-5"></i></button>
                            </div>
                        </div>
                        ${expandedHistoryId === entry.id ? `
                            <div class="mt-6 pt-6 border-t border-slate-50">
                                <h4 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3">Atividades FÃ­sicas</h4>
                                <div class="space-y-2">
                                    ${entry.exercises.map(ex => `<div class="text-xs font-bold text-slate-600 italic flex items-center gap-2"><i data-lucide="dumbbell" class="w-4 h-4 text-blue-400"></i> ${ex}</div>`).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `).join('');
            }
            lucide.createIcons();
        }

        function render() {
            updateDashboard();
            if (activeTab === 'meals') { renderDaySelector(); renderExerciseCard(); renderMeals(); }
            else if (activeTab === 'shopping') renderShopping();
            else if (activeTab === 'history') renderHistory();
        }

        window.onload = () => { render(); lucide.createIcons(); };
    </script>
</body>
</html>
