<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NutriCore - Mobile First</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        
        :root {
            --safe-area-bottom: env(safe-area-inset-bottom, 0px);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
            -webkit-tap-highlight-color: transparent;
            font-size: 16px;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .active-tab {
            color: #10b981;
            position: relative;
        }
        
        .active-tab::after {
            content: '';
            position: absolute;
            bottom: -6px;
            left: 50%;
            transform: translateX(-50%);
            width: 5px;
            height: 5px;
            background: #10b981;
            border-radius: 50%;
        }

        /* Garantir que inputs n√£o fa√ßam zoom no mobile */
        input[type="text"], input[type="number"] {
            font-size: 16px !important;
        }
    </style>
</head>
<body class="text-slate-900 pb-32">

    <!-- Header Fixo -->
    <header class="sticky top-0 z-50 bg-white/90 backdrop-blur-md border-b border-slate-200 px-4 py-4">
        <div class="max-w-md mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-emerald-500 p-2 rounded-xl shadow-sm">
                    <i data-lucide="zap" class="w-5 h-5 text-white fill-white"></i>
                </div>
                <h1 class="font-extrabold text-xl tracking-tight uppercase italic">Nutri<span class="text-emerald-600">Core</span></h1>
            </div>
            <div class="flex gap-2">
                <div class="bg-orange-50 text-orange-600 px-3 py-1.5 rounded-xl border border-orange-100 flex items-center gap-1.5 text-xs font-bold">
                    <i data-lucide="flame" class="w-3.5 h-3.5"></i> <span id="header-net-cals">0</span>
                </div>
                <div class="bg-blue-50 text-blue-600 px-3 py-1.5 rounded-xl border border-blue-100 flex items-center gap-1.5 text-xs font-bold">
                    <i data-lucide="dna" class="w-3.5 h-3.5"></i> <span id="header-protein">0</span>g
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-md mx-auto">
        
        <!-- Dashboard (Ocupa largura total no mobile) -->
        <section class="p-0 sm:p-4 space-y-px sm:space-y-4">
            <!-- Progresso -->
            <div class="bg-white p-6 sm:rounded-2xl shadow-sm border-b sm:border border-slate-100">
                <div class="flex justify-between items-center mb-3">
                    <span class="text-xs font-bold uppercase tracking-widest text-slate-400">Progresso Semanal</span>
                    <span id="weekly-progress-text" class="text-base font-extrabold text-emerald-600">0%</span>
                </div>
                <div class="w-full bg-slate-100 h-3 rounded-full overflow-hidden">
                    <div id="weekly-progress-bar" class="bg-emerald-500 h-full w-0 transition-all duration-1000"></div>
                </div>
                <button onclick="archiveWeek()" id="btn-archive" class="hidden w-full mt-5 py-3 bg-slate-900 text-white rounded-xl text-xs font-bold uppercase tracking-widest active:scale-95 transition-all">
                    Finalizar e Arquivar Semana
                </button>
            </div>
            
            <!-- Grid de M√©tricas -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-px sm:gap-4">
                <div class="bg-white p-5 sm:rounded-2xl border-b sm:border border-slate-100 flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <div class="bg-orange-100 p-2 rounded-lg text-orange-600"><i data-lucide="plus" class="w-4 h-4"></i></div>
                        <div>
                            <div class="text-[10px] font-bold uppercase text-slate-400">Dieta</div>
                            <div id="consumed-cals-text" class="text-lg font-bold">0 kcal</div>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-5 sm:rounded-2xl border-b sm:border border-slate-100 flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <div class="bg-blue-100 p-2 rounded-lg text-blue-600"><i data-lucide="minus" class="w-4 h-4"></i></div>
                        <div>
                            <div class="text-[10px] font-bold uppercase text-slate-400">Queima</div>
                            <div id="burned-cals-text" class="text-lg font-bold">0 kcal</div>
                        </div>
                    </div>
                </div>

                <!-- Adicionado: Card de Prote√≠na para evitar o erro JS -->
                <div class="bg-white p-5 sm:rounded-2xl border-b sm:border border-slate-100 flex justify-between items-center col-span-1 sm:col-span-2">
                    <div class="flex items-center gap-3">
                        <div class="bg-emerald-100 p-2 rounded-lg text-emerald-600"><i data-lucide="dna" class="w-4 h-4"></i></div>
                        <div>
                            <div class="text-[10px] font-bold uppercase text-slate-400">Prote√≠na Di√°ria</div>
                            <div id="protein-text" class="text-lg font-bold">0g</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Selector de Dias (Sticky secund√°rio) -->
        <div id="day-nav" class="sticky top-[73px] z-40 bg-white/70 backdrop-blur-md border-b border-slate-200 flex gap-2 p-3 overflow-x-auto no-scrollbar">
            <!-- Gerado via JS -->
        </div>

        <!-- Views -->
        <div id="view-meals" class="space-y-px sm:space-y-4 sm:p-4">
            <div id="exercise-input" class="p-4 sm:p-0">
                <!-- Gerado via JS -->
            </div>
            <div id="meal-cards" class="space-y-px sm:space-y-3">
                <!-- Gerado via JS -->
            </div>
            <div class="p-6">
                <button onclick="resetMeals()" class="w-full py-4 border-2 border-dashed border-slate-200 text-slate-400 rounded-2xl text-xs font-bold uppercase flex items-center justify-center gap-3 active:bg-slate-50">
                    <i data-lucide="refresh-cw" class="w-4 h-4"></i> Reset ao Plano
                </button>
            </div>
        </div>

        <div id="view-shopping" class="hidden space-y-px sm:space-y-6 sm:p-4">
            <div class="bg-emerald-600 p-8 sm:rounded-3xl text-white shadow-lg text-center">
                <h3 class="font-bold text-2xl flex items-center justify-center gap-3 mb-2"><i data-lucide="shopping-cart" class="w-6 h-6"></i> Lista de Compras</h3>
                <p id="shopping-summary" class="text-xs opacity-90 uppercase font-black tracking-widest">0 itens no carrinho</p>
            </div>
            <div id="shopping-list" class="space-y-8 p-4 sm:p-0">
                <!-- Gerado via JS -->
            </div>
            <div class="p-6">
                <button onclick="resetShopping()" class="w-full py-4 border-2 border-dashed border-slate-200 text-slate-400 rounded-2xl text-xs font-bold uppercase flex items-center justify-center gap-3 active:bg-slate-50">
                    <i data-lucide="refresh-cw" class="w-4 h-4"></i> Limpar Compras
                </button>
            </div>
        </div>

        <div id="view-history" class="hidden p-4 space-y-4">
            <h2 class="font-bold text-slate-400 text-[10px] uppercase tracking-[0.2em] px-1 mb-4">Hist√≥rico de Atividade</h2>
            <div id="history-list" class="space-y-3">
                <!-- Gerado via JS -->
            </div>
            <button onclick="resetHistory()" class="w-full py-4 mt-8 bg-red-50 text-red-500 border border-red-100 rounded-2xl text-xs font-bold uppercase flex items-center justify-center gap-3 active:bg-red-100 transition-colors">
                <i data-lucide="trash-2" class="w-4 h-4"></i> Apagar Tudo
            </button>
        </div>

    </main>

    <!-- Barra de Navega√ß√£o Inferior -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-md border-t border-slate-200 z-50 shadow-[0_-4px_20px_rgba(0,0,0,0.03)]">
        <div class="max-w-md mx-auto flex justify-around items-center pt-4 pb-8 px-4">
            <button onclick="switchTab('meals')" class="flex flex-col items-center gap-1.5 active-tab transition-all" id="nav-meals">
                <div class="p-1"><i data-lucide="calendar" class="w-6 h-6"></i></div>
                <span class="text-[10px] font-bold uppercase tracking-widest">Plano</span>
            </button>
            <button onclick="switchTab('shopping')" class="flex flex-col items-center gap-1.5 text-slate-400 transition-all" id="nav-shopping">
                <div class="relative p-1">
                    <i data-lucide="shopping-cart" class="w-6 h-6"></i>
                    <span id="shopping-badge" class="absolute -top-1 -right-1 bg-red-500 text-white text-[8px] w-4 h-4 rounded-full flex items-center justify-center font-black hidden border-2 border-white">0</span>
                </div>
                <span class="text-[10px] font-bold uppercase tracking-widest">Compras</span>
            </button>
            <button onclick="switchTab('history')" class="flex flex-col items-center gap-1.5 text-slate-400 transition-all" id="nav-history">
                <div class="p-1"><i data-lucide="history" class="w-6 h-6"></i></div>
                <span class="text-[10px] font-bold uppercase tracking-widest">Registo</span>
            </button>
        </div>
    </nav>

    <script>
        // --- DATA ---
        let activeTab = 'meals';
        let selectedDay = '2¬™';
        let completedMeals = {};
        let checkedItems = {};
        let dailyExercise = { '2¬™': { name: '', cals: 0 }, '3¬™': { name: '', cals: 0 }, '4¬™': { name: '', cals: 0 }, '5¬™': { name: '', cals: 0 }, '6¬™': { name: '', cals: 0 } };
        let historyEntries = [];

        const daysList = ['2¬™', '3¬™', '4¬™', '5¬™', '6¬™'];
        
        const mealData = {
            '2¬™': [
                { id: 'pq', title: "Pequeno-Almo√ßo", content: "2 ovos + 1 banana", cals: 245, protein: 14, icon: 'clock' },
                { id: 'al', title: "Almo√ßo", content: "Frango 150g + arroz 75g", subtitle: "Legumes: Br√≥colos", cals: 465, protein: 42, icon: 'activity' },
                { id: 'la', title: "Lanche", content: "Skyr (170g)", cals: 110, protein: 18, icon: 'zap' },
                { id: 'ja', title: "Jantar", content: "Sopa + iogurte + whey", subtitle: "Dose: 350 ml", cals: 320, protein: 28, icon: 'chef-hat' }
            ],
            '3¬™': [
                { id: 'pq', title: "Pequeno-Almo√ßo", content: "2 ovos + 1 banana", cals: 245, protein: 14, icon: 'clock' },
                { id: 'al', title: "Almo√ßo", content: "Frango 150g + gr√£o 100g", subtitle: "Legumes: Cenoura baby", cals: 365, protein: 40, icon: 'activity' },
                { id: 'la', title: "Lanche", content: "Atum (1 lata)", cals: 85, protein: 22, icon: 'zap' },
                { id: 'ja', title: "Jantar", content: "Sopa + omelete", subtitle: "Dose: 350 ml", cals: 315, protein: 18, icon: 'chef-hat' }
            ],
            '4¬™': [
                { id: 'pq', title: "Pequeno-Almo√ßo", content: "2 ovos + 1 banana", cals: 245, protein: 14, icon: 'clock' },
                { id: 'al', title: "Almo√ßo", content: "Salm√£o 150g + arroz 60g", subtitle: "Legumes: Espinafres", cals: 535, protein: 35, icon: 'activity' },
                { id: 'la', title: "Lanche", content: "Iogurte proteico", cals: 95, protein: 20, icon: 'zap' },
                { id: 'ja', title: "Jantar", content: "Sopa + skyr", subtitle: "Dose: 350 ml", cals: 260, protein: 20, icon: 'chef-hat' }
            ],
            '5¬™': [
                { id: 'pq', title: "Pequeno-Almo√ßo", content: "2 ovos + 1 banana", cals: 245, protein: 14, icon: 'clock' },
                { id: 'al', title: "Almo√ßo", content: "Frango 150g + batata 250g", subtitle: "Legumes: Mistura Vegetais", cals: 410, protein: 38, icon: 'activity' },
                { id: 'la', title: "Lanche", content: "Skyr (170g)", cals: 110, protein: 18, icon: 'zap' },
                { id: 'ja', title: "Jantar", content: "Sopa + iogurte + whey", subtitle: "Dose: 350 ml", cals: 320, protein: 28, icon: 'chef-hat' }
            ],
            '6¬™': [
                { id: 'pq', title: "Pequeno-Almo√ßo", content: "2 ovos + 1 banana", cals: 245, protein: 14, icon: 'clock' },
                { id: 'al', title: "Almo√ßo", content: "Salm√£o 150g + gr√£o 100g", subtitle: "Legumes: Couve Bruxelas", cals: 495, protein: 36, icon: 'activity' },
                { id: 'la', title: "Lanche", content: "Iogurte + Atum", cals: 105, protein: 15, icon: 'zap' },
                { id: 'ja', title: "Jantar", content: "Sopa + atum ou skyr", subtitle: "Dose: 350 ml", cals: 255, protein: 25, icon: 'chef-hat' }
            ]
        };

        const shoppingData = [
            { id: 1, cat: 'Prote√≠na', prod: 'Ovos (12 un)', qty: '12 un', price: 3.09, day: '2¬™' },
            { id: 2, cat: 'Prote√≠na', prod: 'Peru (bifes/perna)', qty: '300 g', price: 2.10, day: '2¬™' },
            { id: 3, cat: 'Prote√≠na', prod: 'Frango (peito)', qty: '600 g', price: 1.98, day: '2¬™' },
            { id: 4, cat: 'Prote√≠na', prod: 'Salm√£o (lombos)', qty: '400 g', price: 4.00, day: '2¬™' },
            { id: 5, cat: 'Prote√≠na', prod: 'Atum ao natural', qty: '3 latas', price: 2.67, day: '2¬™' },
            { id: 6, cat: 'Prote√≠na', prod: 'Skyr natural', qty: '3 un', price: 1.95, day: '2¬™' },
            { id: 7, cat: 'Prote√≠na', prod: 'Iogurte proteico', qty: '1 un', price: 0.85, day: '2¬™' },
            { id: 8, cat: 'Prote√≠na', prod: 'Iogurte natural', qty: '2 un', price: 0.35, day: '2¬™' },
            { id: 9, cat: 'Hidratos', prod: 'Arroz', qty: '500 g', price: 0.58, day: '2¬™' },
            { id: 11, cat: 'Hidratos', prod: 'Batata', qty: '1 kg', price: 2.99, day: '2¬™' },
            { id: 12, cat: 'Hidratos', prod: 'Banana', qty: '5 un', price: 1.30, day: '2¬™' },
            { id: 13, cat: 'Hidratos', prod: 'Gr√£o', qty: '400 g', price: 0.90, day: '2¬™' },
            { id: 14, cat: 'Legumes', prod: 'Br√≥colos', qty: '400 g', price: 2.34, day: '2¬™' },
            { id: 15, cat: 'Legumes', prod: 'Cenoura baby', qty: '750g', price: 1.39, day: '2¬™' },
            { id: 17, cat: 'Legumes', prod: 'Espinafres folha', qty: '750 g', price: 1.29, day: '4¬™' },
            { id: 18, cat: 'Legumes', prod: 'Mistura Vegetais', qty: '1 kg', price: 1.89, day: '2¬™' },
            { id: 20, cat: 'Legumes', prod: 'Couve Bruxelas', qty: '750g', price: 1.29, day: '2¬™' },
            { id: 21, cat: 'Sopa', prod: 'Sopa Agri√£o', qty: '800g', price: 2.49, day: '2¬™' },
            { id: 22, cat: 'Sopa', prod: 'Creme Legumes', qty: '800g', price: 2.49, day: '4¬™' },
            { id: 23, cat: 'Sopa', prod: 'Creme Cenoura', qty: '800g', price: 2.49, day: '5¬™' },
        ];

        // --- CORE LOGIC ---

        function switchTab(tabId) {
            activeTab = tabId;
            document.querySelectorAll('[id^="view-"]').forEach(v => v.classList.add('hidden'));
            document.getElementById(`view-${tabId}`).classList.remove('hidden');
            
            document.querySelectorAll('nav button').forEach(b => {
                b.classList.remove('active-tab', 'text-emerald-600');
                b.classList.add('text-slate-400');
            });
            const activeNav = document.getElementById(`nav-${tabId}`);
            activeNav.classList.add('active-tab', 'text-emerald-600');
            activeNav.classList.remove('text-slate-400');
            
            render();
            window.scrollTo({top:0});
        }

        function updateSelectedDay(day) {
            selectedDay = day;
            render();
        }

        function toggleMeal(id) {
            const key = `${selectedDay}-${id}`;
            completedMeals[key] = !completedMeals[key];
            render();
        }

        function toggleShopping(id) {
            checkedItems[id] = !checkedItems[id];
            render();
        }

        function handleExerciseInput(field, val) {
            dailyExercise[selectedDay][field] = field === 'cals' ? (parseInt(val) || 0) : val;
            updateDashboard();
        }

        function resetMeals() { completedMeals = {}; render(); }
        function resetShopping() { checkedItems = {}; render(); }
        function resetHistory() { historyEntries = []; render(); }

        function calculateProgress() {
            const total = daysList.length * 4;
            const done = Object.values(completedMeals).filter(Boolean).length;
            return Math.round((done / total) * 100);
        }

        function archiveWeek() {
            let totalC = 0, totalP = 0, totalB = 0;
            daysList.forEach(d => {
                mealData[d].forEach(m => { if(completedMeals[`${d}-${m.id}`]) { totalC += m.cals; totalP += m.protein; } });
                totalB += dailyExercise[d].cals;
            });

            historyEntries.unshift({
                id: Date.now(),
                date: new Date().toLocaleDateString('pt-PT'),
                progress: calculateProgress(),
                avgCals: Math.round(totalC / 5),
                avgProt: Math.round(totalP / 5),
                burned: totalB
            });

            completedMeals = {};
            dailyExercise = { '2¬™': { name: '', cals: 0 }, '3¬™': { name: '', cals: 0 }, '4¬™': { name: '', cals: 0 }, '5¬™': { name: '', cals: 0 }, '6¬™': { name: '', cals: 0 } };
            switchTab('history');
        }

        // --- RENDER FUNCTIONS ---

        function updateDashboard() {
            const prog = calculateProgress();
            const elProgText = document.getElementById('weekly-progress-text');
            const elProgBar = document.getElementById('weekly-progress-bar');
            
            if (elProgText) elProgText.innerText = `${prog}%`;
            if (elProgBar) elProgBar.style.width = `${prog}%`;
            
            document.getElementById('btn-archive').classList.toggle('hidden', prog === 0);

            const dayMeals = mealData[selectedDay];
            const targetCals = dayMeals.reduce((acc, m) => acc + m.cals, 0);
            const targetProt = dayMeals.reduce((acc, m) => acc + m.protein, 0);
            const burned = dailyExercise[selectedDay].cals;
            const consumed = dayMeals.reduce((acc, m) => completedMeals[`${selectedDay}-${m.id}`] ? acc + m.cals : acc, 0);
            const consumedP = dayMeals.reduce((acc, m) => completedMeals[`${selectedDay}-${m.id}`] ? acc + m.protein : acc, 0);

            document.getElementById('header-net-cals').innerText = targetCals - burned;
            document.getElementById('header-protein').innerText = targetProt;
            document.getElementById('consumed-cals-text').innerText = `${consumed} kcal`;
            document.getElementById('burned-cals-text').innerText = `${burned} kcal`;
            
            // Verifica√ß√£o de seguran√ßa para o elemento de prote√≠na (causa do erro anterior)
            const proteinEl = document.getElementById('protein-text');
            if (proteinEl) {
                proteinEl.innerText = `${consumedP}g / ${targetProt}g`;
            }
        }

        function renderDayNav() {
            const container = document.getElementById('day-nav');
            container.innerHTML = daysList.map(d => `
                <button onclick="updateSelectedDay('${d}')" class="px-6 py-2 rounded-xl text-xs font-bold transition-all whitespace-nowrap ${selectedDay === d ? 'bg-emerald-600 text-white shadow-md' : 'bg-white text-slate-400 border border-slate-200'}">
                    ${d}
                </button>
            `).join('');
        }

        function renderMeals() {
            updateDashboard();
            renderDayNav();
            
            const exerciseContainer = document.getElementById('exercise-input');
            exerciseContainer.innerHTML = `
                <div class="bg-blue-600 p-5 rounded-none sm:rounded-2xl text-white shadow-md relative overflow-hidden">
                    <i data-lucide="dumbbell" class="absolute right-[-10px] bottom-[-10px] w-24 h-24 opacity-10"></i>
                    <div class="relative z-10 space-y-4">
                        <div class="flex justify-between items-center">
                            <span class="text-xs font-bold uppercase tracking-widest opacity-80">Gasto Ativo (${selectedDay})</span>
                            <span class="text-sm font-black bg-white/20 px-2 py-1 rounded">${dailyExercise[selectedDay].cals} kcal</span>
                        </div>
                        <div class="flex gap-2">
                            <input type="text" placeholder="Nome do Treino..." oninput="handleExerciseInput('name', this.value)" value="${dailyExercise[selectedDay].name}" class="bg-white/10 border border-white/20 rounded-xl px-4 py-3 w-full text-sm placeholder:text-blue-200 outline-none focus:bg-white/20">
                            <input type="number" placeholder="kcal" oninput="handleExerciseInput('cals', this.value)" value="${dailyExercise[selectedDay].cals || ''}" class="bg-white/10 border border-white/20 rounded-xl px-4 py-3 w-24 text-sm text-center outline-none focus:bg-white/20">
                        </div>
                    </div>
                </div>
            `;

            const container = document.getElementById('meal-cards');
            container.innerHTML = mealData[selectedDay].map(m => {
                const isDone = completedMeals[`${selectedDay}-${m.id}`];
                return `
                    <div onclick="toggleMeal('${m.id}')" class="bg-white p-5 rounded-none sm:rounded-2xl border-b sm:border border-slate-100 flex items-center gap-5 active:bg-slate-50 transition-all ${isDone ? 'bg-slate-50/50' : ''}">
                        <div class="p-4 rounded-2xl ${isDone ? 'bg-emerald-100 text-emerald-600' : 'bg-slate-50 text-slate-300 shadow-inner'}">
                            <i data-lucide="${isDone ? 'check-circle-2' : m.icon}" class="w-6 h-6"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-start mb-1">
                                <span class="text-[10px] font-bold uppercase text-slate-400 tracking-widest">${m.title}</span>
                                <div class="flex gap-2">
                                    <span class="text-[10px] font-black text-orange-600 bg-orange-50 px-2 py-0.5 rounded-lg border border-orange-100">${m.cals} kcal</span>
                                    <span class="text-[10px] font-black text-blue-600 bg-blue-50 px-2 py-0.5 rounded-lg border border-blue-100">${m.protein}g P</span>
                                </div>
                            </div>
                            <h4 class="text-base font-bold text-slate-800 ${isDone ? 'line-through text-slate-400 italic' : ''}">${m.content}</h4>
                            ${m.subtitle ? `<p class="text-xs text-emerald-600/80 font-bold mt-2 flex items-center gap-1.5"><i data-lucide="info" class="w-3.5 h-3.5"></i> ${m.subtitle}</p>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            lucide.createIcons();
        }

        function renderShopping() {
            const container = document.getElementById('shopping-list');
            const cats = ['Prote√≠na', 'Hidratos', 'Legumes', 'Sopa'];
            
            const total = shoppingData.length;
            const checked = shoppingData.filter(i => checkedItems[i.id]).length;
            document.getElementById('shopping-summary').innerText = `${checked} de ${total} produtos comprados`;
            
            const badge = document.getElementById('shopping-badge');
            badge.innerText = total - checked;
            badge.classList.toggle('hidden', total - checked === 0);

            container.innerHTML = cats.map(cat => {
                const items = shoppingData.filter(i => i.cat === cat);
                return `
                    <div class="space-y-4">
                        <h4 class="text-xs font-black uppercase tracking-[0.2em] text-slate-400 px-1 border-l-4 border-emerald-500 pl-3 ml-1">${cat}</h4>
                        <div class="space-y-px sm:space-y-3">
                            ${items.map(i => {
                                const isChecked = checkedItems[i.id];
                                const isLate = i.day !== '2¬™';
                                return `
                                    <div onclick="toggleShopping(${i.id})" class="bg-white p-5 rounded-none sm:rounded-2xl border-b sm:border flex justify-between items-center active:bg-slate-50 transition-all ${isChecked ? 'bg-slate-50/50 grayscale' : 'border-slate-100 shadow-sm'}">
                                        <div class="flex items-center gap-4">
                                            <div class="transition-all ${isChecked ? 'text-emerald-500 scale-110' : 'text-slate-300'}">
                                                <i data-lucide="${isChecked ? 'check-square' : 'square'}" class="w-6 h-6"></i>
                                            </div>
                                            <div class="flex flex-col">
                                                <span class="text-base font-bold ${isChecked ? 'line-through text-slate-400' : 'text-slate-800'}">${i.prod}</span>
                                                <span class="text-xs font-bold text-slate-400 uppercase tracking-tight">${i.qty} ‚Ä¢ <span class="${isLate ? 'text-amber-500' : ''}">${i.day}</span></span>
                                            </div>
                                        </div>
                                        <span class="text-base font-black text-slate-900">${i.price.toFixed(2)}‚Ç¨</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
            lucide.createIcons();
        }

        function renderHistory() {
            const container = document.getElementById('history-list');
            if(historyEntries.length === 0) {
                container.innerHTML = `<div class="p-16 text-center text-slate-300 font-bold text-sm uppercase italic tracking-widest bg-white rounded-2xl border-2 border-dashed border-slate-100">Sem registos arquivados</div>`;
                return;
            }
            container.innerHTML = historyEntries.map(e => `
                <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm flex justify-between items-center">
                    <div class="min-w-0 flex-1">
                        <h4 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2 italic">Semana de ${e.date}</h4>
                        <div class="flex flex-wrap gap-2">
                            <span class="text-[10px] font-black bg-orange-50 text-orange-600 px-2 py-1 rounded-lg border border-orange-100">~${e.avgCals} kcal/dia</span>
                            <span class="text-[10px] font-black bg-blue-100 text-blue-700 px-2 py-1 rounded-lg border border-blue-200">${e.burned} kcalüî•</span>
                        </div>
                    </div>
                    <div class="text-right ml-4">
                        <div class="text-2xl font-black text-emerald-600">${e.progress}%</div>
                        <div class="text-[9px] font-bold text-slate-300 uppercase tracking-tighter">Conclus√£o</div>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function render() {
            if(activeTab === 'meals') renderMeals();
            else if(activeTab === 'shopping') renderShopping();
            else if(activeTab === 'history') renderHistory();
        }

        window.onload = () => {
            render();
            lucide.createIcons();
        };
    </script>
</body>
</html>
