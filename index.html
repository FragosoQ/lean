<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NutriCore - Suporte Metab√≥lico</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800;900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            -webkit-tap-highlight-color: transparent;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Melhoria de inputs para mobile */
        input {
            font-size: 16px !important; /* Impede zoom no iOS ao focar */
        }

        .transition-all {
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .active-tab-glow {
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.3);
        }
    </style>
</head>
<body class="selection:bg-emerald-100 selection:text-emerald-900 pb-28 min-h-screen">
    <!-- Efeitos de fundo suaves -->
    <div class="fixed top-[-10%] left-[-10%] w-[60%] h-[40%] bg-emerald-100/30 blur-[120px] rounded-full pointer-events-none -z-10"></div>
    <div class="fixed bottom-[-10%] right-[-10%] w-[60%] h-[40%] bg-blue-100/30 blur-[120px] rounded-full pointer-events-none -z-10"></div>

    <!-- Cabe√ßalho Otimizado -->
    <header class="sticky top-0 z-50 bg-white/80 backdrop-blur-lg border-b border-slate-200 px-4 py-3 sm:p-5">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2 sm:gap-3">
                <div class="p-2 bg-emerald-500 rounded-xl shadow-md">
                    <i data-lucide="zap" class="w-4 h-4 sm:w-5 sm:h-5 text-white fill-white"></i>
                </div>
                <div>
                    <h1 class="text-lg sm:text-xl font-black tracking-tight text-slate-900 uppercase italic leading-none">
                        Nutri<span class="text-emerald-600">Core</span>
                    </h1>
                    <p class="text-[9px] text-slate-400 font-bold uppercase tracking-widest mt-0.5">Protocolo Metab√≥lico</p>
                </div>
            </div>
            <div class="text-right flex items-center gap-2 sm:gap-6">
                <div class="flex flex-col items-end">
                    <div class="text-[8px] uppercase tracking-wider text-slate-400 font-bold mb-0.5">Balan√ßo Hoje</div>
                    <div class="flex items-center gap-1.5">
                        <div class="flex items-center gap-1 text-[10px] font-black text-orange-600 bg-orange-50 px-2 py-0.5 rounded-lg border border-orange-100 shadow-sm">
                            <i data-lucide="flame" class="w-2.5 h-2.5"></i> <span id="header-net-cals">0</span>
                        </div>
                        <div class="flex items-center gap-1 text-[10px] font-black text-blue-600 bg-blue-50 px-2 py-0.5 rounded-lg border border-blue-100 shadow-sm">
                            <i data-lucide="dna" class="w-2.5 h-2.5"></i> <span id="header-protein">0</span>g
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto p-4 relative z-10">
        <!-- Dashboard Grelha 2x2 em Mobile -->
        <section id="dashboard" class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-6">
            <div class="glass-card rounded-2xl p-4 shadow-sm border border-white relative overflow-hidden flex flex-col justify-between">
                <div class="flex items-center justify-between mb-2">
                    <h2 class="text-[9px] font-black text-slate-400 uppercase tracking-widest flex items-center gap-1">
                        <i data-lucide="activity" class="w-3 h-3 text-emerald-500"></i> Progresso
                    </h2>
                    <span id="weekly-progress-text" class="text-emerald-600 font-black text-sm">0%</span>
                </div>
                <div class="w-full bg-slate-100 rounded-full h-1.5 overflow-hidden">
                    <div id="weekly-progress-bar" class="bg-emerald-500 h-full rounded-full transition-all duration-700" style="width: 0%"></div>
                </div>
                <button onclick="archiveWeek()" id="btn-archive" class="mt-2 w-full py-1.5 bg-slate-900 text-white rounded-lg text-[8px] font-black uppercase tracking-tighter flex items-center justify-center gap-1 hidden transition-all active:scale-95">
                    <i data-lucide="archive" class="w-2.5 h-2.5"></i> Arquivar
                </button>
            </div>
            <div class="glass-card rounded-2xl p-4 shadow-sm border border-white">
                <div class="flex items-center justify-between mb-1.5">
                    <h2 class="text-[9px] font-black text-slate-400 uppercase tracking-widest flex items-center gap-1"><i data-lucide="plus" class="w-3 h-3 text-orange-500"></i> Ingerido</h2>
                    <span id="consumed-cals-text" class="text-orange-600 font-mono font-bold text-[10px]">0 kcal</span>
                </div>
                <div class="w-full bg-slate-100 rounded-full h-1.5">
                    <div id="consumed-cals-bar" class="bg-orange-500 h-full rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>
            <div class="glass-card rounded-2xl p-4 shadow-sm border border-white">
                <div class="flex items-center justify-between mb-1.5">
                    <h2 class="text-[9px] font-black text-slate-400 uppercase tracking-widest flex items-center gap-1"><i data-lucide="minus" class="w-3 h-3 text-blue-500"></i> Gasto</h2>
                    <span id="burned-cals-text" class="text-blue-600 font-mono font-bold text-[10px]">0 kcal</span>
                </div>
                <div class="w-full bg-slate-100 rounded-full h-1.5">
                    <div id="burned-cals-bar" class="bg-blue-500 h-full rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>
            <div class="glass-card rounded-2xl p-4 shadow-sm border border-white">
                <div class="flex items-center justify-between mb-1.5">
                    <h2 class="text-[9px] font-black text-slate-400 uppercase tracking-widest flex items-center gap-1"><i data-lucide="dna" class="w-3 h-3 text-emerald-500"></i> Prote√≠na</h2>
                    <span id="protein-text" class="text-emerald-600 font-mono font-bold text-[10px]">0g</span>
                </div>
                <div class="w-full bg-slate-100 rounded-full h-1.5">
                    <div id="protein-bar" class="bg-emerald-500 h-full rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>
        </section>

        <!-- Navega√ß√£o Principal -->
        <nav class="flex bg-slate-200/40 backdrop-blur-md rounded-2xl p-1 mb-6 border border-white shadow-sm sticky top-20 z-40">
            <button onclick="switchTab('meals')" id="tab-meals" class="tab-btn flex-1 flex items-center justify-center gap-2 py-2.5 rounded-xl font-bold text-[10px] uppercase tracking-widest transition-all bg-white text-emerald-600 shadow-sm active-tab-glow">
                <i data-lucide="utensils" class="w-3.5 h-3.5"></i> Plano
            </button>
            <button onclick="switchTab('shopping')" id="tab-shopping" class="tab-btn flex-1 flex items-center justify-center gap-2 py-2.5 rounded-xl font-bold text-[10px] uppercase tracking-widest transition-all text-slate-500">
                <i data-lucide="shopping-cart" class="w-3.5 h-3.5"></i> Compras
            </button>
            <button onclick="switchTab('history')" id="tab-history" class="tab-btn flex-1 flex items-center justify-center gap-2 py-2.5 rounded-xl font-bold text-[10px] uppercase tracking-widest transition-all text-slate-500">
                <i data-lucide="history" class="w-3.5 h-3.5"></i> Registo
            </button>
        </nav>

        <!-- Conte√∫do das Abas -->
        <div id="view-meals" class="tab-view space-y-4">
            <div id="day-selector" class="flex gap-2 overflow-x-auto pb-2 no-scrollbar scroll-smooth">
                <!-- Injetado via JS -->
            </div>
            <div id="exercise-card">
                <!-- Injetado via JS -->
            </div>
            <div id="meal-cards-container" class="space-y-3">
                <!-- Injetado via JS -->
            </div>
        </div>

        <div id="view-shopping" class="tab-view hidden space-y-4">
            <div class="bg-emerald-600 rounded-2xl p-5 text-white shadow-lg relative overflow-hidden">
                <h3 class="font-black text-base flex items-center gap-2"><i data-lucide="shopping-cart" class="w-5 h-5"></i> Lista de Compras</h3>
                <p id="shopping-summary" class="text-emerald-100 text-[10px] font-bold uppercase tracking-wider mt-1">Carregando itens...</p>
            </div>
            <div id="shopping-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Injetado via JS -->
            </div>
        </div>

        <div id="view-history" class="tab-view hidden space-y-4">
            <h2 class="text-base font-black text-slate-800 flex items-center gap-2 px-1">
                <i data-lucide="history" class="w-4 h-4 text-emerald-600"></i> Hist√≥rico Semanal
            </h2>
            <div id="history-container" class="space-y-3">
                <!-- Injetado via JS -->
            </div>
        </div>
    </main>

    <!-- Barra de Navega√ß√£o Inferior (Mobile Fix) -->
    <div class="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-xl border-t border-slate-200 px-4 pt-3 pb-6 md:hidden z-50">
        <div class="flex justify-around items-center max-w-lg mx-auto">
            <button onclick="switchTab('meals')" class="mobile-tab-btn flex flex-col items-center gap-1 group" data-tab="meals">
                <div class="p-2.5 rounded-xl transition-all bg-emerald-500 text-white shadow-lg active-tab-glow"><i data-lucide="calendar" class="w-5 h-5"></i></div>
                <span class="text-[8px] font-black uppercase tracking-widest text-emerald-600">Plano</span>
            </button>
            <button onclick="switchTab('shopping')" class="mobile-tab-btn flex flex-col items-center gap-1 group" data-tab="shopping">
                <div class="p-2.5 rounded-xl transition-all relative text-slate-400 group-hover:bg-slate-50">
                    <i data-lucide="shopping-cart" class="w-5 h-5"></i>
                    <span id="shopping-badge" class="absolute top-1 right-1 bg-red-500 text-white text-[7px] w-3.5 h-3.5 rounded-full flex items-center justify-center font-black border border-white hidden">0</span>
                </div>
                <span class="text-[8px] font-black uppercase tracking-widest text-slate-400">Compras</span>
            </button>
            <button onclick="switchTab('history')" class="mobile-tab-btn flex flex-col items-center gap-1 group" data-tab="history">
                <div class="p-2.5 rounded-xl transition-all text-slate-400 group-hover:bg-slate-50"><i data-lucide="history" class="w-5 h-5"></i></div>
                <span class="text-[8px] font-black uppercase tracking-widest text-slate-400">Registo</span>
            </button>
        </div>
    </div>

    <script>
        // --- ESTADO DA APLICA√á√ÉO ---
        let activeTab = 'meals';
        let selectedDay = '2¬™';
        let completedMeals = {};
        let checkedItems = {};
        let dailyExercise = { '2¬™': { name: '', cals: 0 }, '3¬™': { name: '', cals: 0 }, '4¬™': { name: '', cals: 0 }, '5¬™': { name: '', cals: 0 }, '6¬™': { name: '', cals: 0 } };
        let history = [
            { id: 1, date: "03 Fev - 09 Fev", completion: 85, avgCals: 1240, avgProtein: 98, totalBurned: 1200, exercises: ["Corrida 5km", "Treino Pernas"] }
        ];
        let expandedHistoryId = null;

        const daysList = ['2¬™', '3¬™', '4¬™', '5¬™', '6¬™'];
        
        const mealData = {
            '2¬™': [
                { id: 'pq', title: "Pequeno-Almo√ßo", content: "2 ovos + 1 banana", cals: 245, protein: 14, icon: 'clock', color: 'text-orange-500' },
                { id: 'al', title: "Almo√ßo", content: "Frango 150g + arroz 75g (cru)", subtitle: "Legumes: Br√≥colos", cals: 465, protein: 42, icon: 'activity', color: 'text-blue-500' },
                { id: 'la', title: "Lanche", content: "Skyr (170g)", cals: 110, protein: 18, icon: 'zap', color: 'text-purple-500' },
                { id: 'ja', title: "Jantar", content: "Sopa + iogurte natural + 1 scoop whey", subtitle: "Dose: 350 ml", cals: 320, protein: 28, icon: 'chef-hat', color: 'text-emerald-500' }
            ],
            '3¬™': [
                { id: 'pq', title: "Pequeno-Almo√ßo", content: "2 ovos + 1 banana", cals: 245, protein: 14, icon: 'clock', color: 'text-orange-500' },
                { id: 'al', title: "Almo√ßo", content: "Frango 150g + gr√£o 100g", subtitle: "Legumes: Cenoura baby", cals: 365, protein: 40, icon: 'activity', color: 'text-blue-500' },
                { id: 'la', title: "Lanche", content: "Atum (1 lata)", cals: 85, protein: 22, icon: 'zap', color: 'text-purple-500' },
                { id: 'ja', title: "Jantar", content: "Sopa + omelete (2 ovos + 1 clara)", subtitle: "Dose: 350 ml", cals: 315, protein: 18, icon: 'chef-hat', color: 'text-emerald-500' }
            ],
            '4¬™': [
                { id: 'pq', title: "Pequeno-Almo√ßo", content: "2 ovos + 1 banana", cals: 245, protein: 14, icon: 'clock', color: 'text-orange-500' },
                { id: 'al', title: "Almo√ßo", content: "Salm√£o 150g + arroz 60g (cru)", subtitle: "Legumes: Espinafres em folha", cals: 535, protein: 35, icon: 'activity', color: 'text-blue-500' },
                { id: 'la', title: "Lanche", content: "Iogurte proteico", cals: 95, protein: 20, icon: 'zap', color: 'text-purple-500' },
                { id: 'ja', title: "Jantar", content: "Sopa + skyr", subtitle: "Dose: 350 ml", cals: 260, protein: 20, icon: 'chef-hat', color: 'text-emerald-500' }
            ],
            '5¬™': [
                { id: 'pq', title: "Pequeno-Almo√ßo", content: "2 ovos + 1 banana", cals: 245, protein: 14, icon: 'clock', color: 'text-orange-500' },
                { id: 'al', title: "Almo√ßo", content: "Frango 150g + batata 250g", subtitle: "Legumes: Mistura Vegetais", cals: 410, protein: 38, icon: 'activity', color: 'text-blue-500' },
                { id: 'la', title: "Lanche", content: "Skyr (170g)", cals: 110, protein: 18, icon: 'zap', color: 'text-purple-500' },
                { id: 'ja', title: "Jantar", content: "Sopa + iogurte natural + 1 scoop whey", subtitle: "Dose: 350 ml", cals: 320, protein: 28, icon: 'chef-hat', color: 'text-emerald-500' }
            ],
            '6¬™': [
                { id: 'pq', title: "Pequeno-Almo√ßo", content: "2 ovos + 1 banana", cals: 245, protein: 14, icon: 'clock', color: 'text-orange-500' },
                { id: 'al', title: "Almo√ßo", content: "Salm√£o 150g + gr√£o 100g", subtitle: "Legumes: Couve Bruxelas", cals: 495, protein: 36, icon: 'activity', color: 'text-blue-500' },
                { id: 'la', title: "Lanche", content: "Iogurte + Atum", cals: 105, protein: 15, icon: 'zap', color: 'text-purple-500' },
                { id: 'ja', title: "Jantar", content: "Sopa + atum ou skyr", subtitle: "Dose: 350 ml", cals: 255, protein: 25, icon: 'chef-hat', color: 'text-emerald-500' }
            ]
        };

        const shoppingList = [
            { id: 1, cat: 'Prote√≠na', prod: 'Ovos (12 un)', qty: '12 un', price: 3.09, status: 'Comprar', day: '2¬™' },
            { id: 2, cat: 'Prote√≠na', prod: 'Peru (bifes/perna)', qty: '300 g', price: 2.10, status: 'Comprar', day: '2¬™' },
            { id: 3, cat: 'Prote√≠na', prod: 'Frango (peito)', qty: '600 g', price: 1.98, status: 'Comprar', day: '2¬™' },
            { id: 4, cat: 'Prote√≠na', prod: 'Salm√£o (lombos/postas)', qty: '400 g', price: 4.00, status: 'Comprar', day: '2¬™' },
            { id: 5, cat: 'Prote√≠na', prod: 'Atum ao natural', qty: '3 latas', price: 2.67, status: 'Comprar', day: '2¬™' },
            { id: 6, cat: 'Prote√≠na', prod: 'Skyr natural (150 g)', qty: '3 un', price: 1.95, status: 'Comprar', day: '2¬™' },
            { id: 7, cat: 'Prote√≠na', prod: 'Iogurte proteico', qty: '1 un', price: 0.85, status: 'Comprar', day: '2¬™' },
            { id: 8, cat: 'Prote√≠na', prod: 'Iogurte natural', qty: '2 un', price: 0.35, status: 'Comprar', day: '2¬™' },
            { id: 9, cat: 'Prote√≠na', prod: 'Whey', qty: '90 g', price: 3.20, status: 'Stock', day: '‚Äî' },
            { id: 10, cat: 'Hidratos', prod: 'Arroz', qty: '500 g', price: 0.58, status: 'Comprar', day: '2¬™' },
            { id: 11, cat: 'Hidratos', prod: 'Batata', qty: '1 kg', price: 2.99, status: 'Comprar', day: '2¬™' },
            { id: 12, cat: 'Hidratos', prod: 'Banana', qty: '5 un', price: 1.30, status: 'Comprar', day: '2¬™' },
            { id: 13, cat: 'Hidratos', prod: 'Gr√£o', qty: '400 g', price: 0.90, status: 'Comprar', day: '2¬™' },
            { id: 14, cat: 'Legumes', prod: 'Br√≥colos', qty: '400 g', price: 2.34, status: 'Comprar', day: '2¬™' },
            { id: 15, cat: 'Legumes', prod: 'Cenoura baby', qty: '750gr', price: 1.39, status: 'Comprar', day: '2¬™' },
            { id: 17, cat: 'Legumes', prod: 'Espinafres em folha', qty: '750 g', price: 1.29, status: 'Comprar', day: '4¬™' },
            { id: 18, cat: 'Legumes', prod: 'Mistura Vegetais', qty: '1Kg', price: 1.89, status: 'Comprar', day: '2¬™' },
            { id: 24, cat: 'Legumes', prod: 'Couve Bruxelas', qty: '750gr', price: 1.29, status: 'Comprar', day: '2¬™' },
            { id: 20, cat: 'Legumes', prod: 'Cebola', qty: '~300 g', price: 0.56, status: 'Comprar', day: '2¬™' },
            { id: 21, cat: 'Sopa', prod: 'Agri√£o (800gr)', qty: '1 un', price: 2.49, status: 'Comprar', day: '2¬™' },
            { id: 22, cat: 'Sopa', prod: 'Creme Legumes', qty: '1 un', price: 2.49, status: 'Comprar', day: '4¬™' },
            { id: 23, cat: 'Sopa', prod: 'Creme Cenoura', qty: '1 un', price: 2.49, status: 'Comprar', day: '5¬™' },
        ];

        // --- FUN√á√ïES DE L√ìGICA ---

        function switchTab(tabId) {
            activeTab = tabId;
            document.querySelectorAll('.tab-view').forEach(view => view.classList.add('hidden'));
            document.getElementById(`view-${tabId}`).classList.remove('hidden');
            
            // Abas Desktop
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('bg-white', 'text-emerald-600', 'shadow-sm', 'active-tab-glow');
                btn.classList.add('text-slate-500');
            });
            const activeBtn = document.getElementById(`tab-${tabId}`);
            activeBtn.classList.add('bg-white', 'text-emerald-600', 'shadow-sm', 'active-tab-glow');
            activeBtn.classList.remove('text-slate-500');

            // Abas Mobile
            document.querySelectorAll('.mobile-tab-btn').forEach(btn => {
                btn.classList.remove('text-emerald-600', 'scale-110');
                btn.classList.add('text-slate-400');
                const inner = btn.querySelector('div');
                inner.classList.remove('bg-emerald-500', 'text-white', 'shadow-lg', 'active-tab-glow');
                const label = btn.querySelector('span');
                label.classList.remove('text-emerald-600');
                label.classList.add('text-slate-400');
            });
            const activeMobile = document.querySelector(`.mobile-tab-btn[data-tab="${tabId}"]`);
            activeMobile.classList.add('text-emerald-600', 'scale-110');
            const activeInner = activeMobile.querySelector('div');
            activeInner.classList.add('bg-emerald-500', 'text-white', 'shadow-lg', 'active-tab-glow');
            const activeLabel = activeMobile.querySelector('span');
            activeLabel.classList.add('text-emerald-600');
            activeLabel.classList.remove('text-slate-400');

            render();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function updateSelectedDay(day) {
            selectedDay = day;
            render();
        }

        function toggleMeal(mealId) {
            const key = `${selectedDay}-${mealId}`;
            completedMeals[key] = !completedMeals[key];
            render();
        }

        function toggleShopping(id) {
            checkedItems[id] = !checkedItems[id];
            render();
        }

        function handleExerciseInput(field, value) {
            dailyExercise[selectedDay][field] = field === 'cals' ? (parseInt(value) || 0) : value;
            updateDashboard();
        }

        function archiveWeek() {
            let totalCals = 0; let totalProt = 0; let exercisesLog = []; let burnedSum = 0;
            daysList.forEach(day => {
                mealData[day].forEach(item => { if (completedMeals[`${day}-${item.id}`]) { totalCals += item.cals; totalProt += item.protein; } });
                if (dailyExercise[day].cals > 0) {
                    burnedSum += dailyExercise[day].cals;
                    exercisesLog.push(`${day}: ${dailyExercise[day].name || 'Treino'} (${dailyExercise[day].cals} kcal)`);
                }
            });

            const newEntry = {
                id: Date.now(),
                date: `Semana ${new Date().toLocaleDateString('pt-PT')}`,
                completion: calculateProgressValue(),
                avgCals: Math.round(totalCals / 5),
                avgProtein: Math.round(totalProt / 5),
                totalBurned: burnedSum,
                exercises: exercisesLog
            };
            history.unshift(newEntry);
            completedMeals = {}; checkedItems = {};
            dailyExercise = { '2¬™': { name: '', cals: 0 }, '3¬™': { name: '', cals: 0 }, '4¬™': { name: '', cals: 0 }, '5¬™': { name: '', cals: 0 }, '6¬™': { name: '', cals: 0 } };
            switchTab('history');
        }

        function deleteHistory(id) { history = history.filter(h => h.id !== id); render(); }
        function toggleHistoryDetails(id) { expandedHistoryId = expandedHistoryId === id ? null : id; render(); }

        function calculateProgressValue() {
            const totalPossible = daysList.length * 4;
            const completed = Object.values(completedMeals).filter(Boolean).length;
            return Math.round((completed / totalPossible) * 100);
        }

        // --- RENDERIZA√á√ÉO ---

        function updateDashboard() {
            const progress = calculateProgressValue();
            document.getElementById('weekly-progress-text').innerText = `${progress}%`;
            document.getElementById('weekly-progress-bar').style.width = `${progress}%`;
            document.getElementById('btn-archive').classList.toggle('hidden', progress === 0);

            const meals = mealData[selectedDay];
            const targetCals = meals.reduce((acc, curr) => acc + curr.cals, 0);
            const targetProt = meals.reduce((acc, curr) => acc + curr.protein, 0);
            const burned = dailyExercise[selectedDay].cals;
            const consumed = meals.reduce((acc, curr) => completedMeals[`${selectedDay}-${curr.id}`] ? acc + curr.cals : acc, 0);
            const consumedProt = meals.reduce((acc, curr) => completedMeals[`${selectedDay}-${curr.id}`] ? acc + curr.protein : acc, 0);

            document.getElementById('header-net-cals').innerText = targetCals - burned;
            document.getElementById('header-protein').innerText = targetProt;
            document.getElementById('consumed-cals-text').innerText = `${consumed} kcal`;
            document.getElementById('consumed-cals-bar').style.width = `${Math.min((consumed/targetCals)*100, 100)}%`;
            document.getElementById('burned-cals-text').innerText = `${burned} kcal`;
            document.getElementById('burned-cals-bar').style.width = `${Math.min((burned/1000)*100, 100)}%`;
            document.getElementById('protein-text').innerText = `${consumedProt}g / ${targetProt}g`;
            document.getElementById('protein-bar').style.width = `${Math.min((consumedProt/targetProt)*100, 100)}%`;
        }

        function renderDaySelector() {
            const container = document.getElementById('day-selector');
            container.innerHTML = daysList.map(day => `
                <button onclick="updateSelectedDay('${day}')" class="px-7 py-2.5 rounded-xl font-black text-xs whitespace-nowrap transition-all border ${selectedDay === day ? 'bg-emerald-600 text-white border-emerald-600 shadow-md scale-105' : 'bg-white text-slate-400 border-slate-200'}">
                    ${day}
                </button>
            `).join('');
        }

        function renderExerciseCard() {
            const container = document.getElementById('exercise-card');
            container.innerHTML = `
                <div class="bg-gradient-to-br from-blue-600 to-blue-700 rounded-2xl p-4 sm:p-5 shadow-lg text-white relative overflow-hidden group mb-4">
                    <div class="absolute top-0 right-0 p-4 opacity-10"><i data-lucide="dumbbell" class="w-16 h-16"></i></div>
                    <div class="flex flex-col gap-3 relative z-10">
                        <div class="flex-1">
                            <h4 class="text-[8px] font-black uppercase tracking-widest text-blue-100 mb-1">Exerc√≠cio Hoje</h4>
                            <input type="text" placeholder="O que treinaste?" class="bg-white/10 border border-white/20 rounded-lg px-3 py-2 w-full text-white placeholder:text-blue-200 font-bold focus:outline-none focus:bg-white/20" value="${dailyExercise[selectedDay].name}" oninput="handleExerciseInput('name', this.value)">
                        </div>
                        <div class="flex flex-col w-full">
                            <h4 class="text-[8px] font-black uppercase tracking-widest text-blue-100 mb-1">Queima (kcal)</h4>
                            <input type="number" placeholder="0" class="bg-white/10 border border-white/20 rounded-lg px-3 py-2 w-full text-white placeholder:text-blue-200 font-bold focus:outline-none focus:bg-white/20 text-center" value="${dailyExercise[selectedDay].cals || ''}" oninput="handleExerciseInput('cals', this.value)">
                        </div>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        function renderMeals() {
            const container = document.getElementById('meal-cards-container');
            container.innerHTML = mealData[selectedDay].map(meal => {
                const isCompleted = completedMeals[`${selectedDay}-${meal.id}`];
                return `
                    <div onclick="toggleMeal('${meal.id}')" class="glass-card rounded-2xl p-4 border transition-all cursor-pointer shadow-sm active:scale-[0.98] ${isCompleted ? 'opacity-60 border-transparent bg-slate-50' : 'border-white'}">
                        <div class="flex items-center gap-3 sm:gap-4">
                            <div class="p-3 rounded-xl transition-all ${isCompleted ? 'bg-emerald-100 text-emerald-600' : 'bg-slate-50 text-slate-400 shadow-inner'}">
                                <i data-lucide="${isCompleted ? 'check-circle-2' : meal.icon}" class="w-5 h-5"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex justify-between items-start mb-0.5">
                                    <h4 class="text-[8px] font-black uppercase tracking-widest truncate ${isCompleted ? 'text-emerald-600/50' : 'text-slate-400'}">${meal.title}</h4>
                                    <div class="flex items-center gap-1">
                                        <span class="flex items-center gap-0.5 bg-orange-50 px-1.5 py-0.5 rounded-md text-[8px] font-black text-orange-600"><i data-lucide="flame" class="w-2.5 h-2.5"></i> ${meal.cals}</span>
                                        <span class="flex items-center gap-0.5 bg-blue-50 px-1.5 py-0.5 rounded-md text-[8px] font-black text-blue-600"><i data-lucide="dna" class="w-2.5 h-2.5"></i> ${meal.protein}g</span>
                                    </div>
                                </div>
                                <p class="text-sm font-black text-slate-900 leading-tight ${isCompleted ? 'line-through italic text-slate-400' : ''}">${meal.content}</p>
                                ${meal.subtitle ? `<p class="text-[10px] mt-1 text-emerald-600/70 font-semibold truncate"><i data-lucide="info" class="w-2.5 h-2.5 inline mr-0.5"></i> ${meal.subtitle}</p>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            lucide.createIcons();
        }

        function renderShopping() {
            const container = document.getElementById('shopping-container');
            const total = shoppingList.length;
            const bought = shoppingList.filter(i => checkedItems[i.id]).length;
            document.getElementById('shopping-summary').innerText = `${bought} de ${total} itens adquiridos`;
            
            const badge = document.getElementById('shopping-badge');
            badge.innerText = total - bought;
            badge.classList.toggle('hidden', total - bought === 0);

            container.innerHTML = ['Prote√≠na', 'Hidratos', 'Legumes', 'Sopa'].map(cat => {
                const items = shoppingList.filter(i => i.cat === cat);
                return `
                    <div class="bg-white rounded-2xl p-4 shadow-sm border border-slate-100">
                        <h3 class="font-black text-slate-800 mb-3 text-[10px] uppercase tracking-widest border-l-4 border-emerald-500 pl-2 flex justify-between">
                            ${cat} <span class="text-slate-300 font-normal">${items.filter(i => checkedItems[i.id]).length}/${items.length}</span>
                        </h3>
                        <ul class="space-y-2">
                            ${items.map(item => {
                                const isEx = item.status !== 'Comprar' || item.day !== '2¬™';
                                const check = checkedItems[item.id];
                                return `
                                    <li onclick="toggleShopping(${item.id})" class="flex justify-between items-center p-2.5 rounded-xl border transition-all ${check ? 'bg-slate-50 opacity-40 grayscale border-transparent' : isEx ? 'bg-amber-50/50 border-amber-100' : 'bg-white border-slate-100'}">
                                        <div class="flex items-center gap-2">
                                            <i data-lucide="${check ? 'check-square' : 'square'}" class="w-4 h-4 ${check ? 'text-emerald-500' : 'text-slate-300'}"></i>
                                            <div class="flex flex-col min-w-0">
                                                <span class="text-xs font-bold truncate">${item.prod}</span>
                                                <span class="text-[9px] text-slate-400">${item.qty} ‚Ä¢ ${item.day}</span>
                                            </div>
                                        </div>
                                        <span class="text-[10px] font-black whitespace-nowrap ml-2">${item.price.toFixed(2)}‚Ç¨</span>
                                    </li>
                                `;
                            }).join('')}
                        </ul>
                    </div>
                `;
            }).join('');
            lucide.createIcons();
        }

        function renderHistory() {
            const container = document.getElementById('history-container');
            if (history.length === 0) {
                container.innerHTML = `<div class="p-10 text-center opacity-40 font-black uppercase text-[10px] tracking-widest">Vazio</div>`;
            } else {
                container.innerHTML = history.map(entry => `
                    <div class="bg-white rounded-2xl p-4 shadow-sm border border-slate-100 overflow-hidden">
                        <div class="flex justify-between items-center">
                            <div class="min-w-0 flex-1">
                                <h3 class="text-xs font-black text-slate-800 truncate">${entry.date}</h3>
                                <div class="flex gap-1.5 mt-2 overflow-x-auto no-scrollbar">
                                    <span class="bg-orange-50 text-orange-600 px-1.5 py-0.5 rounded text-[8px] font-bold whitespace-nowrap">~${entry.avgCals} kcal</span>
                                    <span class="bg-blue-50 text-blue-600 px-1.5 py-0.5 rounded text-[8px] font-bold whitespace-nowrap">~${entry.avgProtein}g P</span>
                                    <span class="bg-blue-100 text-blue-800 px-1.5 py-0.5 rounded text-[8px] font-bold whitespace-nowrap">${entry.totalBurned} kcalüî•</span>
                                </div>
                            </div>
                            <div class="flex items-center gap-3 ml-4">
                                <div class="text-right">
                                    <div class="text-[8px] text-slate-400 font-black uppercase tracking-widest">Meta</div>
                                    <div class="text-base font-black ${entry.completion > 80 ? 'text-emerald-600' : 'text-amber-500'}">${entry.completion}%</div>
                                </div>
                                <button onclick="toggleHistoryDetails(${entry.id})" class="p-2 bg-slate-50 rounded-lg text-slate-400"><i data-lucide="${expandedHistoryId === entry.id ? 'chevron-up' : 'chevron-down'}" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                        ${expandedHistoryId === entry.id ? `
                            <div class="mt-4 pt-4 border-t border-slate-50">
                                <h4 class="text-[8px] font-black text-slate-300 uppercase tracking-widest mb-2">Treinos</h4>
                                <div class="space-y-1.5">
                                    ${entry.exercises.map(ex => `<div class="text-[10px] font-bold text-slate-500 italic flex items-center gap-1.5"><i data-lucide="dumbbell" class="w-3 h-3 text-blue-400"></i> ${ex}</div>`).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `).join('');
            }
            lucide.createIcons();
        }

        function render() {
            updateDashboard();
            if (activeTab === 'meals') { renderDaySelector(); renderExerciseCard(); renderMeals(); }
            else if (activeTab === 'shopping') renderShopping();
            else if (activeTab === 'history') renderHistory();
        }

        window.onload = () => { render(); lucide.createIcons(); };
    </script>
</body>
</html>
